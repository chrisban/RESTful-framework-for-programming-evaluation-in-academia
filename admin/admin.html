<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>
			Server-side code compilation/execution
		</title>
		<script type="text/javascript" src="/includes/js/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="/includes/js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
		<link type="text/css" href="/includes/js/jquery-ui-1.11.4/jquery-ui.min.css" rel="stylesheet" media="screen"/>
		<link type="text/css" href="/admin/styling.css" rel="stylesheet" media="screen"/>
	</head>
	<script>
		$( document ).ready(function() {
			$( "#infoModal" ).dialog({
				autoOpen: false,
				buttons: [{
					id: "dialogCloseBtn",
			    	text: "Close",
			    	click: function(){
						$(this).dialog("close");
			    	}
			    }]
			});

			$("#uploadBtn").on("click", function(){
				//Ensure courseid and key are provided
				if($('#courseID').val() != '' && $('#activityID').val() != '') {
					if($('#fileInput').val() != '') {
						var file = new FormData();
						file.append($('#courseID').val() + '===' + $('#activityID').val(), $('#fileInput')[0].files[0]);

						$.ajax({
							url: '/uploadFile',
							type: 'POST',
							data: file,
							cache: false,
							contentType: false,
							processData: false,
							success: function(res){
								$( "#infoModal" ).html('Upload validation successful: ' + res['success']);
								$( "#infoModal" ).dialog('open');
							},
						    error: function(res){
						    	console.log("Error response: ", res);
						    }
						});
					} else {
						var tmpCode = JSON.stringify($('#code').val());

						//only parse if ANY code is wrapped
						if(tmpCode.indexOf('_<<') != -1 && tmpCode.indexOf('_>>') != -1) {
							//using lookahead so we don't lose our separator and have no way of telling which was wrapped
							//structure: [content, separator, wrap content, separator, content]
							var split = tmpCode.split(/(_<<_|_>>_)/); 

							var nextIsWrapped = false;
							for(var i = 0; i < split.length; i++) {
								//if true, next element is wrapped. Remove marker and continue to wrapped element
								if(split[i] == "_<<_") {
									nextIsWrapped = true;
									split[i] = "";
								} else if(split[i] == "_>>_") { //if true, just finished with a wrapped element. Remove marker and set flag to false.
									nextIsWrapped = false;
									split[i] = "";
								} else if(nextIsWrapped === true) { //if true, this element is wrapped. Escape all newlines and set false for sake of consistency.
									split[i] = split[i].replace(/\\n/g, "\\\\n");
									nextIsWrapped = false;
								}
							}

							tmpCode = split.join('');
							console.log('total: ', JSON.parse(tmpCode));
						}
						

						$.ajax({
						    url: "/uploadFile",
						    type: "POST",
						    dataType: "json",
						    data: JSON.stringify({ course_id: $('#courseID').val(), act_id: $('#activityID').val(), code: tmpCode }),
						    contentType: "application/json",
						    cache: false,
						    success: function(res){
						    	$( "#infoModal" ).html('Upload validation successful: <b>' + res['success'] + '</b>');
								$( "#infoModal" ).dialog('open');
						    },
						    error: function(res){
						    	console.log("Error response: ", res);
						    }
						});
					}
				} else {
					$( "#infoModal" ).html('You must provide course and quiz/exam IDs');
					$( "#infoModal" ).dialog('open');
				}
			});
		});
	</script>
	<body> 
		<div id='container'>
			<div id='upload'> 
				<h1>Upload datafile</h1>
				<span id='format'> Format: JSON (<a href='/admin/examples/json/jsonExample.html' target="_blank">ex</a>)<br /></span><br />
				If a file is selected, all text area data will be ignored.<br /><br />

				<div id='fileDetails'>
					<b>Course ID:</b> <input id='courseID' type='text' /> <br /><br />
					<b>Activity ID:</b> <input id='activityID' type='text' />
				</div>

				<div id='fileUpload'>
					<b>valid JSON datafile:</b> <br />
					<input type="file" id="fileInput" />
				</div>
			</div>

			<div id='lazy'>
				<div id='codeDiv'>
					<h2>JSON with unformatted content (hard line breaks): </h2>
					<span id='format'> Format: JSON-esque (<a href='/admin/examples/json/jsonesqueExample.html' target="_blank">ex</a>)<br /></span><br />

					<span id='note'>Please Note:<br />
					- The 'problem' field will only use html formatting/markup.<br />
					- If any double quotes are repeated, they must be escaped ("skeleton": " cout << \"i\"; " )<br />
					- Each field should include no hard linebreaks. Otherwise, wrap unformatted text in the following manner: '_<<_ CONTENT _>>_' <br />&nbsp&nbsp(or explicity write /n, /t, etc.).</span>
					<textarea id='code'></textarea>
				</div>
			</div>

			<div id="infoModal"><!--jq modal--></div>
			<input type="button" id="uploadBtn" value='Upload'>
			
		</div>
	</body>
</html>