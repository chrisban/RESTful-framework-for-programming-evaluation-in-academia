<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<title>
			Server-side code compilation/execution
		</title>

		<script type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
		<script type="text/javascript" src="js/jquery-ui-1.11.4/jquery-ui.min.js"></script>
		<script src="js/codemirror-5.3/lib/codemirror.js"></script>

		<link rel="stylesheet" href="js/codemirror-5.3/lib/codemirror.css">
		<link type="text/css" href="js/jquery-ui-1.11.4/jquery-ui.min.css" rel="stylesheet" media="screen"/>
		<link type="text/css" href="css/screen.css" rel="stylesheet" media="screen"/>
	</head>

	<script>
		$(function() {

			//predefined code
			$('textarea#code').val('#include <iostream>\n \
int main()\n \
{\n \
	int input = 0;\n \
	for(int i = 0; i <= 2; i++)\n \
	{\n \
		if(i == 0)\n \
			std::cout << "init input: " << input << std::endl;\n \
		else\n \
		{\n \
			std::cin >> input;\n \
			std::cout << "new input: " << input << "\\n";\n \
		}\n \
	}\n \
}');

			/*$('textarea#code').val('#include <iostream>\n\n \
int main()\n \
{\n \
	std::cout << "Hello World!" << std::endl;\n \
}');*/

			//enable codeMirror editor
			var editor = CodeMirror.fromTextArea(document.getElementById("code"), {
		        lineNumbers: true,
		        matchBrackets: true,
		        mode: "javascript"
		     });

			//on compile
			$('#compile').on('click', function(){
				var val = $("textarea#code").val();
				console.log("pre-posted code:\n", val);
				val = val.replace(/\\n/g, "\\n");
				val = val.replace(/<br>/g, "\n");
				val = val.replace(/&lt;/g, "<");
				val = val.replace(/&gt;/g, ">");
				val = val.replace(/&nbsp;/g, "");
				val = val.replace(/<div>/g, "\r\n");
				val = val.replace(/<\/div>/g, "\r\n");
				console.log("\nPosted code:\n", val);
				

				//TODO: POST code, populate results with return value
				
				/*
				//COLIRU: #include <iostream>\n int main() \n{\n std::cout << "Hello, world!\\n";\n}
				var http = new XMLHttpRequest();
				http.open("POST", "http://coliru.stacked-crooked.com/compile", false);
				http.send(JSON.stringify({ "cmd": "g++ main.cpp && ./a.out << EOF\r\n1\r\n2\r\nEOF\r\n", "src": val }));
				$("#codeResults").val(http.response);
				*/
				
				
				//REXTESTER:
				var data = {
					"LanguageChoiceWrapper": "7", 
					"Program": val, 
					"input": "1 2", 
					"compilerArgs": "source_file.cpp -o a.out"
				};

				$.ajax({
				  type: "POST",
				  url: "http://rextester.com/rundotnet/api",
				  dataType: "JSON",
				  data: data,
				  success: function(response){
					if(!$('#results').is(':visible'))
						$('#results').show("blind", 500);
				  	console.log("resp:", response);

				  	var result = "";
				  	if(response.Errors)
				  		result += "Errors: " + response.Errors;
				  	if(response.Warnings)
				  		result += "Warnings: " + response.Warnings;
				  	if(response.Result)
				  		result += "Result: " + response.Result;
				  	$("#codeResults").val(result);
				  }
				});
				

			});
		});
	</script>

	<body>
		<div id="container">
			<div id="banner">
				<h1>Code compilation and execution</h1>
			</div>

			Enter or modify the code below and press 'Compile' to view results. <br /><br /> 

			<div id="codeContainer"><textarea id='code' ></textarea></div><br />
			<input type="button" id="compile" value="Compile">

			<div id="results">
				<b>Results:</b> <br />
				<textarea id="codeResults" rows="5" cols="100"></textarea>	
			</div>
		</div>
	</body>
</html>